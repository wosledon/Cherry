<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cherry FLV Streaming Demo</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .status.online {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.offline {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .stream-list {
            display: grid;
            gap: 10px;
        }
        .stream-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        video {
            width: 100%;
            max-width: 800px;
            height: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .controls {
            margin: 10px 0;
        }
        .info {
            font-size: 0.9em;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Cherry FLV Streaming Demo</h1>

        <div class="section">
            <h2>服务器状态</h2>
            <div id="serverStatus" class="status offline">服务器离线</div>
            <div class="controls">
                <button id="startServer">启动RTMP服务器</button>
                <button id="stopServer">停止RTMP服务器</button>
                <button id="refreshStatus">刷新状态</button>
            </div>
        </div>

        <div class="section">
            <h2>活动流列表</h2>
            <div id="streamList" class="stream-list">
                <p>暂无活动流</p>
            </div>
            <button id="refreshStreams">刷新流列表</button>
        </div>

        <div class="section">
            <h2>FLV播放器</h2>
            <div class="controls">
                <input type="text" id="streamKeyInput" placeholder="输入流密钥 (例如: live)" value="live">
                <button id="playStream">播放流</button>
                <button id="stopStream">停止播放</button>
            </div>
            <video id="flvPlayer" controls>
                您的浏览器不支持video标签。
            </video>
            <div id="streamInfo" class="info"></div>
        </div>

        <div class="section">
            <h2>使用说明</h2>
            <ol>
                <li>点击"启动RTMP服务器"启动服务器</li>
                <li>使用OBS推流到 <code>rtmp://localhost:1935/live</code></li>
                <li>在流列表中查看活动流</li>
                <li>输入流密钥并点击"播放流"观看直播</li>
            </ol>
            <h3>OBS配置</h3>
            <ul>
                <li>流类型: 自定义流媒体服务器</li>
                <li>URL: <code>rtmp://localhost:1935/live</code></li>
                <li>流密钥: <code>live</code> (或您配置的密钥)</li>
            </ul>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;

        // DOM元素
        const serverStatus = document.getElementById('serverStatus');
        const startServerBtn = document.getElementById('startServer');
        const stopServerBtn = document.getElementById('stopServer');
        const refreshStatusBtn = document.getElementById('refreshStatus');
        const streamList = document.getElementById('streamList');
        const refreshStreamsBtn = document.getElementById('refreshStreams');
        const streamKeyInput = document.getElementById('streamKeyInput');
        const playStreamBtn = document.getElementById('playStream');
        const stopStreamBtn = document.getElementById('stopStream');
        const flvPlayer = document.getElementById('flvPlayer');
        const streamInfo = document.getElementById('streamInfo');

        let currentStreamUrl = null;

        // 事件监听器
        startServerBtn.addEventListener('click', startServer);
        stopServerBtn.addEventListener('click', stopServer);
        refreshStatusBtn.addEventListener('click', checkServerStatus);
        refreshStreamsBtn.addEventListener('click', loadStreams);
        playStreamBtn.addEventListener('click', playStream);
        stopStreamBtn.addEventListener('click', stopStream);

        // 页面加载时检查状态
        window.addEventListener('load', () => {
            checkServerStatus();
            loadStreams();
        });

        // 启动服务器
        async function startServer() {
            try {
                setButtonsState(true);
                const response = await fetch(`${API_BASE}/api/rtmp/start`, {
                    method: 'GET'
                });
                const result = await response.json();

                if (response.ok) {
                    serverStatus.textContent = `服务器运行中 - 端口: ${result.port}`;
                    serverStatus.className = 'status online';
                    alert('RTMP服务器已启动！');
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                alert('启动服务器失败: ' + error.message);
                serverStatus.textContent = '服务器启动失败';
                serverStatus.className = 'status offline';
            } finally {
                setButtonsState(false);
            }
        }

        // 停止服务器
        async function stopServer() {
            try {
                setButtonsState(true);
                const response = await fetch(`${API_BASE}/api/rtmp/stop`, {
                    method: 'POST'
                });
                const result = await response.json();

                if (response.ok) {
                    serverStatus.textContent = '服务器已停止';
                    serverStatus.className = 'status offline';
                    alert('RTMP服务器已停止！');
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                alert('停止服务器失败: ' + error.message);
            } finally {
                setButtonsState(false);
            }
        }

        // 检查服务器状态
        async function checkServerStatus() {
            try {
                const response = await fetch(`${API_BASE}/api/health`);
                if (response.ok) {
                    serverStatus.textContent = 'Web服务器运行中';
                    serverStatus.className = 'status online';
                } else {
                    throw new Error();
                }
            } catch (error) {
                serverStatus.textContent = '服务器离线';
                serverStatus.className = 'status offline';
            }
        }

        // 加载流列表
        async function loadStreams() {
            try {
                const response = await fetch(`${API_BASE}/api/flv/streams`);
                const streams = await response.json();

                if (streams.length === 0) {
                    streamList.innerHTML = '<p>暂无活动流</p>';
                    return;
                }

                streamList.innerHTML = streams.map(streamKey => `
                    <div class="stream-item">
                        <span>${streamKey}</span>
                        <button onclick="playSpecificStream('${streamKey}')">播放</button>
                    </div>
                `).join('');

            } catch (error) {
                streamList.innerHTML = '<p>加载流列表失败</p>';
                console.error('Load streams error:', error);
            }
        }

        // 播放指定流
        function playSpecificStream(streamKey) {
            streamKeyInput.value = streamKey;
            playStream();
        }

        // 播放流
        async function playStream() {
            const streamKey = streamKeyInput.value.trim();
            if (!streamKey) {
                alert('请输入流密钥');
                return;
            }

            try {
                // 停止当前播放
                stopStream();

                // 获取流信息
                const infoResponse = await fetch(`${API_BASE}/api/flv/streams/${streamKey}/info`);
                if (infoResponse.ok) {
                    const info = await infoResponse.json();
                    streamInfo.textContent = `流: ${info.streamKey}, 状态: ${info.isActive ? '活跃' : '非活跃'}, 帧数: ${info.frameCount}, 时长: ${Math.floor(info.duration / 10000000)}秒`;
                }

                // 设置播放源
                currentStreamUrl = `${API_BASE}/flv/${streamKey}`;
                flvPlayer.src = currentStreamUrl;
                flvPlayer.play();

                playStreamBtn.disabled = true;
                stopStreamBtn.disabled = false;

            } catch (error) {
                alert('播放流失败: ' + error.message);
                console.error('Play stream error:', error);
            }
        }

        // 停止播放
        function stopStream() {
            flvPlayer.pause();
            flvPlayer.src = '';
            currentStreamUrl = null;
            streamInfo.textContent = '';

            playStreamBtn.disabled = false;
            stopStreamBtn.disabled = true;
        }

        // 设置按钮状态
        function setButtonsState(loading) {
            startServerBtn.disabled = loading;
            stopServerBtn.disabled = loading;
        }

        // 定期刷新流列表
        setInterval(loadStreams, 5000);
    </script>
</body>
</html>